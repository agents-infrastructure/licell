name: release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag, e.g. v1.0.0"
        required: true
        type: string
      ref:
        description: "Git ref to build from (branch/tag/sha), default main"
        required: false
        default: "main"
        type: string

permissions:
  contents: read

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.ref || github.ref }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.3"

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Typecheck
        run: bun run typecheck

      - name: Test
        run: bun test

  build:
    needs: verify
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: linux
            arch: x64
            runner: ubuntu-latest
          - os: linux
            arch: arm64
            runner: ubuntu-24.04-arm
          - os: darwin
            arch: x64
            runner: macos-13
          - os: darwin
            arch: arm64
            runner: macos-14
    runs-on: ${{ matrix.runner }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.ref || github.ref }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.3"

      - name: Build standalone artifact
        run: bun run build:standalone

      - name: Verify artifact exists
        run: |
          test -f "dist/licell-${{ matrix.os }}-${{ matrix.arch }}.tar.gz"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: licell-${{ matrix.os }}-${{ matrix.arch }}
          path: dist/licell-${{ matrix.os }}-${{ matrix.arch }}.tar.gz
          if-no-files-found: error
          retention-days: 7

  publish:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.ref || github.ref }}

      - name: Resolve release metadata
        id: meta
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "tag=${{ inputs.tag }}" >> "$GITHUB_OUTPUT"
            echo "target_ref=${{ inputs.ref }}" >> "$GITHUB_OUTPUT"
          else
            echo "tag=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"
            echo "target_ref=${GITHUB_SHA}" >> "$GITHUB_OUTPUT"
          fi

      - name: Ensure tag exists
        run: |
          TAG="${{ steps.meta.outputs.tag }}"
          git fetch --tags origin
          if ! git rev-parse -q --verify "refs/tags/${TAG}" >/dev/null; then
            git tag "${TAG}" "${{ steps.meta.outputs.target_ref }}"
            git push origin "refs/tags/${TAG}"
          fi

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: licell-*
          path: dist-release
          merge-multiple: true

      - name: Generate checksums
        run: |
          cd dist-release
          sha256sum *.tar.gz > SHA256SUMS.txt

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.tag }}
          target_commitish: ${{ steps.meta.outputs.target_ref }}
          generate_release_notes: true
          prerelease: ${{ contains(steps.meta.outputs.tag, '-') }}
          files: |
            dist-release/licell-darwin-arm64.tar.gz
            dist-release/licell-darwin-x64.tar.gz
            dist-release/licell-linux-arm64.tar.gz
            dist-release/licell-linux-x64.tar.gz
            dist-release/SHA256SUMS.txt
